{% extends "base.html" %}
{% block title %}ì¹´í˜ ì¶”ì²œ{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/cafe.css') }}">
{% endblock %}

{% block content %}
<!-- âœ… Flaskì—ì„œ region/categoryë¥¼ JSì—ì„œë„ ì“°ê¸° ìœ„í•´ ë³€ìˆ˜ë¡œ ë¨¼ì € ì„ ì–¸ -->
<script>
  const region = "{{ region }}";
  const category = "{{ selected_category }}";
</script>

<div class="grid-layout">
  <!-- ğŸ”¹ ì™¼ìª½: ì…ë ¥ì°½ + ì¹´í˜ ë¦¬ìŠ¤íŠ¸ -->
  <div class="left-panel">
    <h3>ì§€ì—­ ì…ë ¥</h3>
    <form method="POST">
      <input type="text" name="region" placeholder="ì˜ˆ: ë¶€ì‚° í•´ìš´ëŒ€" value="{{ region }}" autocomplete="off" required>
      
      <h3>ì¹´í˜ ì¢…ë¥˜</h3>
      <select name="category">
        <option value="" {% if not selected_category %}selected{% endif %}>ì „ì²´</option>
        <option value="ë² ì´ì»¤ë¦¬" {% if selected_category == "ë² ì´ì»¤ë¦¬" %}selected{% endif %}>ë² ì´ì»¤ë¦¬ì¹´í˜</option>
        <option value="ë””ì €íŠ¸" {% if selected_category == "ë””ì €íŠ¸" %}selected{% endif %}>ë””ì €íŠ¸ì¹´í˜</option>
        <option value="ë¸ŒëŸ°ì¹˜" {% if selected_category == "ë¸ŒëŸ°ì¹˜" %}selected{% endif %}>ë¸ŒëŸ°ì¹˜ì¹´í˜</option>
        <option value="ë³´ë“œ" {% if selected_category == "ë³´ë“œ" %}selected{% endif %}>ë³´ë“œì¹´í˜</option>
        <option value="ëŒ€í˜•" {% if selected_category == "ëŒ€í˜•" %}selected{% endif %}>ëŒ€í˜•ì¹´í˜</option>
      </select>

      <div style="text-align: right;">
        <button type="submit">ê²€ìƒ‰</button>
      </div>
    </form>

    <ul class="place-list">
      {% for place in places %}
      <li class="place-item" data-lat="{{ place.lat }}" data-lng="{{ place.lng }}">
        <strong>{{ place.name }}</strong><br>
        <small>{{ place.address }}</small>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- ğŸ”¹ ê°€ìš´ë°: ì§€ë„ + ìƒì„¸ ì •ë³´ + ë¸”ë¡œê·¸ í›„ê¸° -->
  <div class="center-panel">
    <h3>ì§€ë„</h3>
    <div id="map" style="width: 100%; height: 500px;"></div>

    <div id="info-box" style="display:none; margin-top: 20px; padding: 16px; background: #f9f9f9; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h3 id="info-name"></h3>
      <p><strong>ì£¼ì†Œ:</strong> <span id="info-address"></span></p>
      <p><strong>ì „í™”:</strong> <span id="info-phone"></span></p>
      <p><strong>ì¢…ë¥˜:</strong> <span id="info-category"></span></p>
      <p><strong>ë§í¬:</strong> <a id="info-link" href="#" target="_blank">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a></p>

      <!-- âœ… ë¸”ë¡œê·¸ í›„ê¸° ì˜ì—­ -->
      <div id="blog-section" style="margin-top: 20px;">
        <h4><span class="naver-green">NAVER</span> ë¸”ë¡œê·¸ í›„ê¸°</h4>
        <div id="blog-list">
          <p>ì¹´í˜ë¥¼ í´ë¦­í•˜ë©´ ë¸”ë¡œê·¸ í›„ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ ì˜¤ë¥¸ìª½: GPT ìœ íŠœë¸Œ ì¶”ì²œ -->
  <div class="right-panel">
    <h3>ìœ íŠœë¸Œ ì¹´í˜ ì¶”ì²œ</h3>
    <div class="youtube-list">
      {% for video in youtube_videos %}
      <div class="youtube-card">
        <a href="{{ video.url }}" target="_blank">
          <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
        </a>
        <p class="video-title">
          <a href="{{ video.url }}" target="_blank">{{ video.title }}</a>
        </p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- âœ… Kakao ì§€ë„ JS -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
kakao.maps.load(function () {
  const mapContainer = document.getElementById('map');
  const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
  const map = new kakao.maps.Map(mapContainer, {
    center: center,
    level: 5
  });

  const markerList = [];
  const places = {{ places | tojson | safe }};

  function showInfoBox(place) {
    document.getElementById("info-name").innerText = place.name;
    document.getElementById("info-address").innerText = place.address || "ì •ë³´ ì—†ìŒ";
    document.getElementById("info-phone").innerText = place.phone || "ì •ë³´ ì—†ìŒ";
    document.getElementById("info-link").href = place.url || "#";
    document.getElementById("info-box").style.display = "block";
    document.getElementById("info-category").innerText = place.category || "ì •ë³´ ì—†ìŒ";

    fetch("/blog_search", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ query: `${region} ${place.name}` })
    })
    .then(res => res.json())
    .then(data => {
      const blogList = document.getElementById("blog-list");
      blogList.innerHTML = "";
      if (data.length > 0) {
        data.forEach(post => {
          const div = document.createElement("div");
          div.className = "blog-card";
          div.style = "background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:8px;";
          div.innerHTML = `<a href="${post.link}" target="_blank" style="font-weight:bold;">${post.title}</a><br><small>${post.description}</small>`;
          blogList.appendChild(div);
        });
      } else {
        blogList.innerHTML = "<p>ë¸”ë¡œê·¸ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
    })
    .catch(err => {
      document.getElementById("blog-list").innerHTML = "<p>ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜</p>";
    });
  }

  document.querySelectorAll('.place-item').forEach(item => {
    const lat = parseFloat(item.dataset.lat);
    const lng = parseFloat(item.dataset.lng);
    const name = item.querySelector('strong').innerText;

    const pos = new kakao.maps.LatLng(lat, lng);
    const marker = new kakao.maps.Marker({ map: map, position: pos });

    const info = new kakao.maps.InfoWindow({
      content: `<div style="padding:6px;font-size:13px;"><b>${name}</b></div>`
    });

    markerList.push({ marker, info });

    kakao.maps.event.addListener(marker, 'click', () => {
      markerList.forEach(m => m.info.close());
      info.open(map, marker);
      const matched = places.find(p => parseFloat(p.lat) === lat && parseFloat(p.lng) === lng);
      if (matched) showInfoBox(matched);
    });

    item.addEventListener('click', () => {
      map.setCenter(pos);
      map.setLevel(4);
      markerList.forEach(m => m.info.close());
      info.open(map, marker);
      const matched = places.find(p => parseFloat(p.lat) === lat && parseFloat(p.lng) === lng);
      if (matched) showInfoBox(matched);
    });
  });
});
</script>
{% endblock %}
