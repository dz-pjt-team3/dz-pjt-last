{% extends "base.html" %}

{% block title %}ğŸ“‹ ì¼ì • ë³´ê¸°{% endblock %}

{% block content %}
<header class="site-header">
  <h1>AI ì—¬í–‰ ì¼ì • ìƒì„±ê¸°</h1>
</header>
<script>
  const KAKAO_REST_API_KEY = "{{ kakao_rest_api_key }}";
</script>

<div class="grid-container">
  <!-- âœ… ì™¼ìª½: ì¼ì • ì¶œë ¥ ì˜ì—­ -->
  <div class="center-panel">
    <h3>ì—¬í–‰ ì¼ì •</h3>

    {% if result %}
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <!-- âœ… PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
      <form method="POST" action="{{ url_for('download_pdf') }}">
        <textarea name="result_html" style="display: none;">{{ result | safe }}</textarea>
        <button type="submit" class="pdf-btn">ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°</button>
      </form>

      <!-- âœ… ê³µìœ  ë§í¬ ë³µì‚¬ ë²„íŠ¼ -->
      <button class="pdf-btn" onclick="copyLink()">ğŸ”— ê³µìœ  ë§í¬ ë³µì‚¬</button>
    </div>
    <p id="share-result" style="color: gray;"></p>

    <!-- âœ… ì¼ì • ì¶œë ¥ ë°•ìŠ¤ -->
    <div class="itinerary-box">
      {{ result | safe }}
    </div>
    {% endif %}
  </div>

  <!-- âœ… ì˜¤ë¥¸ìª½: ì§€ë„ ë° ë¦¬ë·° ì˜ì—­ -->
  <div class="right-panel">
    <h3>ì§€ë„</h3>
    <div id="map" style="height: 450px;"></div>

    {% if result %}
    <!-- âœ… ë¦¬ë·° ì…ë ¥ ë° ëª©ë¡ ì¶œë ¥ (ì¼ì •ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
    <div class="review-wrapper">
      <hr>
      <h3>â­ ë¦¬ë·° ë‚¨ê¸°ê¸°</h3>
      <form method="POST" action="{{ url_for('plan') }}" class="review-form">
        <label>í‰ì :</label><br>
        <div class="star-rating">
          {% for i in range(5, 0, -1) %}
            <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
            <label for="star{{ i }}">â˜…</label>
          {% endfor %}
        </div>

        <label for="comment">ë¦¬ë·°:</label>
        <textarea name="comment" required></textarea>

        <!-- âœ… ì—¬ê¸°ì— ìˆ¨ê²¨ì§„ input ê°’ë“¤ì„ ì¶”ê°€ -->
        <input type="hidden" name="result_html" value="{{ result | tojson | safe }}">
        <input type="hidden" name="markers" value='{{ markers | tojson | safe }}'>
        <input type="hidden" name="center_lat" value="{{ center_lat }}">
        <input type="hidden" name="center_lng" value="{{ center_lng }}">
        <input type="hidden" name="route_data" value='{{ route_data | tojson | safe }}'>
        <input type="hidden" name="start_date" value="{{ start_date }}">
        <input type="hidden" name="end_date" value="{{ end_date }}">
        <input type="hidden" name="companions" value="{{ companions }}">
        <input type="hidden" name="people_count" value="{{ people_count }}">
        <input type="hidden" name="user_prompt" value="{{ user_prompt }}">
        <input type="hidden" name="location" value="{{ location }}">
        <input type="hidden" name="transport_mode" value="{{ transport_mode }}">
        {% for t in theme %}
          <input type="hidden" name="theme" value="{{ t }}">
        {% endfor %}

        <button type="submit" class="pdf-btn">ë¦¬ë·° ì œì¶œ</button>
      </form>


      <hr>
      <h3>ğŸ“¢ ì‚¬ìš©ì ë¦¬ë·°</h3>
      {% if reviews|length > 0 %}
        {% set total_rating = 0 %}
        {% for review in reviews %}
          {% set total_rating = total_rating + review.rating|int %}
        {% endfor %}
        {% set avg_rating = (total_rating / reviews|length)|round(1) %}
        <p><strong>â­ í‰ê·  í‰ì : {{ avg_rating }}ì </strong></p>

        <ul>
          {% for review in reviews %}
            <li>
              <strong>
                {% for i in range(review.rating|int) %}â˜…{% endfor %}
                {% for i in range(5 - review.rating|int) %}â˜†{% endfor %}
              </strong><br>
              {{ review.comment }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- âœ… ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ -->
<style>
  .place-link {
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
  }
  .place-link:hover {
    background-color: #eaf4ff;
  }
  .itinerary-box {
    height: 600px;      /* ì§€ë„ ë†’ì´ì™€ ë™ì¼í•˜ê²Œ */
    overflow-y: auto;   /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
    padding-right: 10px;/* ìŠ¤í¬ë¡¤ë°”ì™€ ë‚´ìš© ê²¹ì¹¨ ë°©ì§€ ì—¬ë°± */
  }
  .pdf-btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 12px;
  }
  .pdf-btn:hover {
    background-color: #218838;
  }
</style>

<!-- Kakao Maps JavaScript SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
async function fetchDirections(origin, destination) {
  const res  = await fetch(`/api/directions?origin=${origin}&destination=${destination}`);
  const json = await res.json();
  if (!json.routes) throw new Error(json.error || 'ê²½ë¡œì •ë³´ ì—†ìŒ');
  // summary ì— distance(m), duration(s) ì •ë³´ê°€ ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.
  return json.routes[0].summary;
}
// Kakao Maps API ë¡œë“œ í›„ ì‹¤í–‰
kakao.maps.load(function () {
  let currentInfoWindow = null;

  // 1) ì§€ë„ ìƒì„±
  const mapContainer = document.getElementById('map');
  const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
  const map = new kakao.maps.Map(mapContainer, { center: center, level: 6 });

  // êµí†µì •ë³´ ì˜¤ë²„ë ˆì´
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);

  // 2) ë§ˆì»¤ ë°ì´í„°(Flat) ë°›ì•„ì˜¤ê¸°
  const markerData = {{ markers | tojson | safe }};

  // 3) ì¼ì°¨ë³„ ìƒ‰ìƒ ì •ì˜
  const colors = {
    '1ì¼ì°¨': '#FF5858',
    '2ì¼ì°¨': '#3F88C5',
    '3ì¼ì°¨': '#82C91E',
    // ì¶”ê°€ ì¼ìê°€ ìˆìœ¼ë©´ ë” ë„£ìœ¼ì„¸ìš”
  };

  // 4) markerData â†’ ì¼ì°¨ë³„ ê·¸ë£¹í•‘
  const dataByDay = {};
  markerData.forEach(m => {
    if (!dataByDay[m.day]) dataByDay[m.day] = [];
    dataByDay[m.day].push(m);
  });

  // 5) SVG ì›í˜• ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„± í—¬í¼
  function createCircleSVG(color) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
        <circle cx="12" cy="12" r="10" fill="${color}" stroke="#fff" stroke-width="2"/>
      </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg.trim());
  }

  // 6) ì¼ì°¨ë³„ ë§ˆì»¤Â·í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸° & markerDict ì¬êµ¬ì„±
  const markerDict = {};
  Object.entries(dataByDay).forEach(([day, places]) => {
    const color = colors[day] || '#000000';
    const markerImage = new kakao.maps.MarkerImage(
      createCircleSVG(color),
      new kakao.maps.Size(24, 24),
      { offset: new kakao.maps.Point(12, 12) }
    );
    
    let prevPos = null;
    
    // 6-1) ë§ˆì»¤ ìƒì„± ë° InfoWindow
    places.forEach(async p => {
      const pos = new kakao.maps.LatLng(p.lat, p.lng);
      const marker = new kakao.maps.Marker({
        map,
        position: pos,
        image: markerImage,
        title: `${day} Â· ${p.name}`
      });
      // InfoWindow ë‚´ìš© ì¡°ë¦½ ì‹œì‘
      let content = `
        <div style="display:inline-block;white-space:nowrap;padding:6px 10px;font-size:13px;font-family:'Malgun Gothic';">
          <b>${day} ${p.time}</b><br>
          <b>ğŸ  ${p.name}</b>
      `;

      // ì´ì „ ì§€ì ì´ ìˆìœ¼ë©´ ê±°ë¦¬Â·ì†Œìš”ì‹œê°„ API í˜¸ì¶œ
      if (prevPos) {
        try {
          const originStr      = `${prevPos.getLng()},${prevPos.getLat()}`;
          const destinationStr = `${p.lng},${p.lat}`;
          const summary        = await fetchDirections(originStr, destinationStr);
          const km   = (summary.distance  / 1000).toFixed(1);
          const min  = Math.ceil(summary.duration / 60);
          content += `<br>ê±°ë¦¬: ${km}km, ì†Œìš”: ${min}ë¶„`;
        } catch (e) {
          console.warn(day, p.name, 'ê±°ë¦¬ì¡°íšŒ ì‹¤íŒ¨:', e);
        }
      }
      content += `</div>`;
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // InfoWindow ìƒì„±Â·ì´ë²¤íŠ¸
      const info = new kakao.maps.InfoWindow({
        content, removable: true
      });
      kakao.maps.event.addListener(marker, 'click', () => {
        if (currentInfoWindow) currentInfoWindow.close();
        info.open(map, marker);
        currentInfoWindow = info;
      });
      markerDict[p.name] = { marker, info, pos };
      prevPos = pos;
    });

// 6-2) ì¼ì°¨ë³„ ë‹¤ì¤‘ ê²½ìœ ì§€ ê¸¸ì°¾ê¸° API í˜¸ì¶œ í›„ í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
   if (places.length >= 2) {
     // ì¢Œí‘œ ë¬¸ìì—´ ë°°ì—´: ["lng,lat", ...]
     const coords = places.map(p => `${p.lng},${p.lat}`);
     const origin      = coords[0];
     const destination = coords[coords.length - 1];
     const waypoints   = coords.slice(1, -1).join('|'); // ì¤‘ê°„ ê²½ìœ ì§€

     const url = `/api/waypoints-directions`
               + `?origin=${origin}`
               + `&destination=${destination}`
               + (waypoints ? `&waypoints=${waypoints}` : '');

     fetch(url)
    .then(res => res.json())
    .then(json => {
      // â‘¢ ëª¨ë“  sections ì˜ path ì¢Œí‘œë¥¼ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
      const routePath = [];
      json.routes[0].sections.forEach(section => {
        section.path.forEach(pt => {
          routePath.push(new kakao.maps.LatLng(pt[1], pt[0]));
        });
      });

      // â‘£ ì¼ì°¨ë³„ ìƒ‰ìƒìœ¼ë¡œ í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
      new kakao.maps.Polyline({
        path: routePath,
        strokeWeight: 4,
        strokeColor: colors[day],
        strokeOpacity: 0.8,
        map
      });
    })
    .catch(err => console.error(`${day} ê²½ë¡œì¡°íšŒ ì˜¤ë¥˜:`, err));
    }
  });

  // 7) ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  document.querySelectorAll('.place-link').forEach(el => {
    el.addEventListener('click', () => {
      const name = el.dataset.name;
      const data = markerDict[name];
      if (!data) return;
      if (currentInfoWindow) currentInfoWindow.close();
      map.setCenter(data.pos);
      data.info.open(map, data.marker);
      currentInfoWindow = data.info;
    });
  });
// 5) ë‹¤ì¤‘ ê²½ìœ ì§€ Polyline í‘œì‹œ
    const routeData = {{ route_data | tojson | safe }};
    if (routeData.routes && routeData.routes.length > 0) {
      const sections = routeData.routes[0].sections;
      const linePath = [];

      sections.forEach(sec => {
        sec.roads.forEach(rd => {
          const verts = rd.vertexes;  // [ê²½ë„, ìœ„ë„, ê²½ë„, ìœ„ë„, â€¦] í˜•íƒœ :contentReference[oaicite:0]{index=0}
          for (let i = 0; i < verts.length; i += 2) {
            const lng = verts[i], lat = verts[i+1];
            linePath.push(new kakao.maps.LatLng(lat, lng));
          }
        });
      });

      // Polyline ìƒì„±
      const polyline = new kakao.maps.Polyline({
        path: linePath,
        strokeWeight: 4,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8
      });
      polyline.setMap(map);

      // ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
      const bounds = new kakao.maps.LatLngBounds();
      linePath.forEach(latlng => bounds.extend(latlng));
      map.setBounds(bounds);
    }
  });
</script>

<!-- âœ… ê³µìœ  ë§í¬ ë³µì‚¬ JS -->
<script>
function copyLink() {
  fetch("/save_share", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ html: document.querySelector(".itinerary-box").innerHTML })
  })
  .then(response => response.json())
  .then(data => {
    const fullUrl = `${window.location.origin}/share/${data.share_id}`;
    navigator.clipboard.writeText(fullUrl).then(() => {
      document.getElementById("share-result").innerText = `ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${fullUrl}`;
    });
  });
}
</script>
{% endblock %}
